
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>syms_vel_meas</title><meta name="generator" content="MATLAB 9.5"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2020-05-11"><meta name="DC.source" content="syms_vel_meas.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h2>Contents</h2><div><ul><li><a href="#3">pos</a></li><li><a href="#4">vel</a></li><li><a href="#5">acc</a></li><li><a href="#6">att</a></li><li><a href="#7">ars</a></li><li><a href="#8">error state def</a></li><li><a href="#9">imu</a></li><li><a href="#10">lever arm</a></li><li><a href="#11">simple measurement</a></li><li><a href="#12">measurement</a></li></ul></div><pre class="codeinput">clc
clear <span class="string">all</span>
</pre><pre class="codeinput">z31 = zeros(3,1);
z_151 = zeros(15,1);
</pre><h2 id="3">pos</h2><pre class="codeinput">syms <span class="string">px_n</span> <span class="string">py_n</span> <span class="string">pz_n</span> <span class="string">real</span>
p_hat = [px_n; py_n; pz_n];
syms <span class="string">d_px_n</span> <span class="string">d_py_n</span> <span class="string">d_pz_n</span> <span class="string">real</span>
d_p = [d_px_n; d_py_n; d_pz_n];
p = p_hat + d_p
</pre><pre class="codeoutput"> 
p =
 
 d_px_n + px_n
 d_py_n + py_n
 d_pz_n + pz_n
 
</pre><h2 id="4">vel</h2><pre class="codeinput">syms <span class="string">vx_n</span> <span class="string">vy_n</span> <span class="string">vz_n</span> <span class="string">real</span>
v_hat = [vx_n; vy_n; vz_n];
syms <span class="string">d_vx_n</span> <span class="string">d_vy_n</span> <span class="string">d_vz_n</span> <span class="string">real</span>
d_v = [d_vx_n; d_vy_n; d_vz_n];

v = v_hat + d_v
</pre><pre class="codeoutput"> 
v =
 
 d_vx_n + vx_n
 d_vy_n + vy_n
 d_vz_n + vz_n
 
</pre><h2 id="5">acc</h2><pre class="codeinput">syms <span class="string">b_accx_b</span> <span class="string">b_accy_b</span> <span class="string">b_accz_b</span> <span class="string">real</span>
b_acc_b_hat = [b_accx_b; b_accy_b; b_accz_b];
syms <span class="string">d_b_accx_b</span> <span class="string">d_b_accy_b</span> <span class="string">d_b_accz_b</span> <span class="string">real</span>
d_b_acc = [d_b_accx_b; d_b_accy_b; d_b_accz_b];

b_acc_b = b_acc_b_hat + d_b_acc
</pre><pre class="codeoutput"> 
b_acc_b =
 
 b_accx_b + d_b_accx_b
 b_accy_b + d_b_accy_b
 b_accz_b + d_b_accz_b
 
</pre><h2 id="6">att</h2><pre class="codeinput">syms <span class="string">d_theta_x</span> <span class="string">d_theta_y</span> <span class="string">d_theta_z</span> <span class="string">real</span>
d_theta = [d_theta_x; d_theta_y; d_theta_z];
d_R = eye(3) + Smtrx(d_theta)
<span class="comment">%syms q_w q_x q_y q_z real</span>
<span class="comment">%q = [q_w; q_x; q_y; q_z];</span>
<span class="comment">%R_hat = quat2rotMat_fast(q )</span>
syms <span class="string">R11</span> <span class="string">R12</span> <span class="string">R13</span> <span class="string">R21</span> <span class="string">R22</span> <span class="string">R23</span> <span class="string">R31</span> <span class="string">R32</span> <span class="string">R33</span> <span class="string">real</span>
R_hat = [<span class="keyword">...</span>
    R11 R12 R13;
    R21 R22 R23;
    R31 R32 R33 ]
R = R_hat*d_R;
</pre><pre class="codeoutput"> 
d_R =
 
[          1, -d_theta_z,  d_theta_y]
[  d_theta_z,          1, -d_theta_x]
[ -d_theta_y,  d_theta_x,          1]
 
 
R_hat =
 
[ R11, R12, R13]
[ R21, R22, R23]
[ R31, R32, R33]
 
</pre><h2 id="7">ars</h2><pre class="codeinput">syms <span class="string">b_arsx_b</span> <span class="string">b_arsy_b</span> <span class="string">b_arsz_b</span> <span class="string">real</span>
b_ars_b_hat = [b_arsx_b; b_arsy_b; b_arsz_b];
syms <span class="string">d_b_arsx_b</span> <span class="string">d_b_arsy_b</span> <span class="string">d_b_arsz_b</span> <span class="string">real</span>
d_b_ars = [d_b_arsx_b; d_b_arsy_b; d_b_arsz_b];

b_ars_b = b_ars_b_hat + d_b_ars
</pre><pre class="codeoutput"> 
b_ars_b =
 
 b_arsx_b + d_b_arsx_b
 b_arsy_b + d_b_arsy_b
 b_arsz_b + d_b_arsz_b
 
</pre><h2 id="8">error state def</h2><pre class="codeinput">d_x = [d_p; d_v; d_b_acc; d_theta; d_b_ars];
</pre><h2 id="9">imu</h2><p>syms ox_b oy_b oz_b real omega_nb = [ox_b oy_b oz_b]; syms wx_ars_b wy_ars_b wz_ars_b real w_ars_b = [wx_ars_b; wy_ars_b; wz_ars_b]</p><pre class="codeinput">syms <span class="string">ox_imu_b</span> <span class="string">oy_imu_b</span> <span class="string">oz_imu_b</span> <span class="string">real</span>
omega_imu_b = [ox_imu_b; oy_imu_b; oz_imu_b]
</pre><pre class="codeoutput"> 
omega_imu_b =
 
 ox_imu_b
 oy_imu_b
 oz_imu_b
 
</pre><h2 id="10">lever arm</h2><pre class="codeinput">syms <span class="string">rx_b</span> <span class="string">ry_b</span> <span class="string">rz_b</span> <span class="string">real</span>
r_b = [rx_b; ry_b; rz_b ]
</pre><pre class="codeoutput"> 
r_b =
 
 rx_b
 ry_b
 rz_b
 
</pre><h2 id="11">simple measurement</h2><pre class="codeinput">H_alloc = [1 0 0];
y_gss = H_alloc*( R'*v + Smtrx( omega_imu_b - b_ars_b)*r_b );
y_hat = subs(y_gss, d_x, z_151 )
H = jacobian( y_gss, d_x );
H = simplify( subs( H, d_x, zeros(15,1) ));
H_pos = H(:,1:3)
H_vel = H(:,4:6)
H_acc = H(:,7:9)
H_att = H(:,10:12)
H_ars = H(:,13:15)

<span class="comment">% matriseregne sjekk, svar skal bli null</span>
delta_H_pos = H(:,1:3) - H_alloc*z31
delta_H_vel = H(:,4:6) - H_alloc*R_hat'
delta_H_acc = H(:,7:9) - H_alloc*z31
delta_H_att = H(:,10:12) - H_alloc*Smtrx( R_hat'*v_hat )
delta_H_ars = H(:,13:15) - [1 0 0]*Smtrx(r_b)
</pre><pre class="codeoutput"> 
y_hat =
 
R11*vx_n + R21*vy_n + R31*vz_n - rz_b*(b_arsy_b - oy_imu_b) + ry_b*(b_arsz_b - oz_imu_b)
 
 
H_pos =
 
[ 0, 0, 0]
 
 
H_vel =
 
[ R11, R21, R31]
 
 
H_acc =
 
[ 0, 0, 0]
 
 
H_att =
 
[ 0, - R13*vx_n - R23*vy_n - R33*vz_n, R12*vx_n + R22*vy_n + R32*vz_n]
 
 
H_ars =
 
[ 0, -rz_b, ry_b]
 
 
delta_H_pos =
 
[ 0, 0, 0]
 
 
delta_H_vel =
 
[ 0, 0, 0]
 
 
delta_H_acc =
 
[ 0, 0, 0]
 
 
delta_H_att =
 
[ 0, 0, 0]
 
 
delta_H_ars =
 
[ 0, 0, 0]
 
</pre><h2 id="12">measurement</h2><pre class="codeinput">H_alloc = [1 0 0; 0 1 0; 0 0 0];
velocity_gss = H_alloc*( R'*v + Smtrx( omega_imu_b - b_ars_b)*r_b );
y_gss = norm( velocity_gss );
y_hat = simplify( subs(y_gss, d_x, z_151 ) );
H = jacobian( y_gss, d_x );
H = simplify( subs( H, d_x, zeros(15,1) ) )

<span class="comment">%</span>
H_pos = H(:,1:3)
H_vel = H(:,4:6)
H_acc = H(:,7:9)
H_att = H(:,10:12)
H_ars = H(:,13:15)

<span class="comment">% se p&aring; forskjellen til</span>
H_alloc = [1 0 0];
y_gss = H_alloc*( R'*v + Smtrx( omega_imu_b - b_ars_b)*r_b )
<span class="comment">% og</span>
H_alloc = [1 0 0; 0 1 0; 0 0 0];
velocity_gss = H_alloc*( R'*v + Smtrx( omega_imu_b - b_ars_b)*r_b );
y_gss = norm( velocity_gss );
<span class="comment">% i simulatoren</span>
</pre><pre class="codeoutput"> 
H =
 
[ 0, 0, 0, (R12*(R12*vx_n + R22*vy_n + R32*vz_n - b_arsz_b*rx_b + b_arsx_b*rz_b - ox_imu_b*rz_b + oz_imu_b*rx_b) + R11*(R11*vx_n + R21*vy_n + R31*vz_n + b_arsz_b*ry_b - b_arsy_b*rz_b + oy_imu_b*rz_b - oz_imu_b*ry_b))/((R12*vx_n + R22*vy_n + R32*vz_n - b_arsz_b*rx_b + b_arsx_b*rz_b - ox_imu_b*rz_b + oz_imu_b*rx_b)^2 + (R11*vx_n + R21*vy_n + R31*vz_n + b_arsz_b*ry_b - b_arsy_b*rz_b + oy_imu_b*rz_b - oz_imu_b*ry_b)^2)^(1/2), (R22*(R12*vx_n + R22*vy_n + R32*vz_n - b_arsz_b*rx_b + b_arsx_b*rz_b - ox_imu_b*rz_b + oz_imu_b*rx_b) + R21*(R11*vx_n + R21*vy_n + R31*vz_n + b_arsz_b*ry_b - b_arsy_b*rz_b + oy_imu_b*rz_b - oz_imu_b*ry_b))/((R12*vx_n + R22*vy_n + R32*vz_n - b_arsz_b*rx_b + b_arsx_b*rz_b - ox_imu_b*rz_b + oz_imu_b*rx_b)^2 + (R11*vx_n + R21*vy_n + R31*vz_n + b_arsz_b*ry_b - b_arsy_b*rz_b + oy_imu_b*rz_b - oz_imu_b*ry_b)^2)^(1/2), (R32*(R12*vx_n + R22*vy_n + R32*vz_n - b_arsz_b*rx_b + b_arsx_b*rz_b - ox_imu_b*rz_b + oz_imu_b*rx_b) + R31*(R11*vx_n + R21*vy_n + R31*vz_n + b_arsz_b*ry_b - b_arsy_b*rz_b + oy_imu_b*rz_b - oz_imu_b*ry_b))/((R12*vx_n + R22*vy_n + R32*vz_n - b_arsz_b*rx_b + b_arsx_b*rz_b - ox_imu_b*rz_b + oz_imu_b*rx_b)^2 + (R11*vx_n + R21*vy_n + R31*vz_n + b_arsz_b*ry_b - b_arsy_b*rz_b + oy_imu_b*rz_b - oz_imu_b*ry_b)^2)^(1/2), 0, 0, 0, ((R13*vx_n + R23*vy_n + R33*vz_n)*(R12*vx_n + R22*vy_n + R32*vz_n - b_arsz_b*rx_b + b_arsx_b*rz_b - ox_imu_b*rz_b + oz_imu_b*rx_b))/((R12*vx_n + R22*vy_n + R32*vz_n - b_arsz_b*rx_b + b_arsx_b*rz_b - ox_imu_b*rz_b + oz_imu_b*rx_b)^2 + (R11*vx_n + R21*vy_n + R31*vz_n + b_arsz_b*ry_b - b_arsy_b*rz_b + oy_imu_b*rz_b - oz_imu_b*ry_b)^2)^(1/2), -((R13*vx_n + R23*vy_n + R33*vz_n)*(R11*vx_n + R21*vy_n + R31*vz_n + b_arsz_b*ry_b - b_arsy_b*rz_b + oy_imu_b*rz_b - oz_imu_b*ry_b))/((R12*vx_n + R22*vy_n + R32*vz_n - b_arsz_b*rx_b + b_arsx_b*rz_b - ox_imu_b*rz_b + oz_imu_b*rx_b)^2 + (R11*vx_n + R21*vy_n + R31*vz_n + b_arsz_b*ry_b - b_arsy_b*rz_b + oy_imu_b*rz_b - oz_imu_b*ry_b)^2)^(1/2), -(2*(R11*vx_n + R21*vy_n + R31*vz_n)*(R12*vx_n + R22*vy_n + R32*vz_n - b_arsz_b*rx_b + b_arsx_b*rz_b - ox_imu_b*rz_b + oz_imu_b*rx_b) - 2*(R12*vx_n + R22*vy_n + R32*vz_n)*(R11*vx_n + R21*vy_n + R31*vz_n + b_arsz_b*ry_b - b_arsy_b*rz_b + oy_imu_b*rz_b - oz_imu_b*ry_b))/(2*((R12*vx_n + R22*vy_n + R32*vz_n - b_arsz_b*rx_b + b_arsx_b*rz_b - ox_imu_b*rz_b + oz_imu_b*rx_b)^2 + (R11*vx_n + R21*vy_n + R31*vz_n + b_arsz_b*ry_b - b_arsy_b*rz_b + oy_imu_b*rz_b - oz_imu_b*ry_b)^2)^(1/2)), (rz_b*(R12*vx_n + R22*vy_n + R32*vz_n - b_arsz_b*rx_b + b_arsx_b*rz_b - ox_imu_b*rz_b + oz_imu_b*rx_b))/((R12*vx_n + R22*vy_n + R32*vz_n - b_arsz_b*rx_b + b_arsx_b*rz_b - ox_imu_b*rz_b + oz_imu_b*rx_b)^2 + (R11*vx_n + R21*vy_n + R31*vz_n + b_arsz_b*ry_b - b_arsy_b*rz_b + oy_imu_b*rz_b - oz_imu_b*ry_b)^2)^(1/2), -(rz_b*(R11*vx_n + R21*vy_n + R31*vz_n + b_arsz_b*ry_b - b_arsy_b*rz_b + oy_imu_b*rz_b - oz_imu_b*ry_b))/((R12*vx_n + R22*vy_n + R32*vz_n - b_arsz_b*rx_b + b_arsx_b*rz_b - ox_imu_b*rz_b + oz_imu_b*rx_b)^2 + (R11*vx_n + R21*vy_n + R31*vz_n + b_arsz_b*ry_b - b_arsy_b*rz_b + oy_imu_b*rz_b - oz_imu_b*ry_b)^2)^(1/2), -(rx_b*(R12*vx_n + R22*vy_n + R32*vz_n - b_arsz_b*rx_b + b_arsx_b*rz_b - ox_imu_b*rz_b + oz_imu_b*rx_b) - ry_b*(R11*vx_n + R21*vy_n + R31*vz_n + b_arsz_b*ry_b - b_arsy_b*rz_b + oy_imu_b*rz_b - oz_imu_b*ry_b))/((R12*vx_n + R22*vy_n + R32*vz_n - b_arsz_b*rx_b + b_arsx_b*rz_b - ox_imu_b*rz_b + oz_imu_b*rx_b)^2 + (R11*vx_n + R21*vy_n + R31*vz_n + b_arsz_b*ry_b - b_arsy_b*rz_b + oy_imu_b*rz_b - oz_imu_b*ry_b)^2)^(1/2)]
 
 
H_pos =
 
[ 0, 0, 0]
 
 
H_vel =
 
[ (R12*(R12*vx_n + R22*vy_n + R32*vz_n - b_arsz_b*rx_b + b_arsx_b*rz_b - ox_imu_b*rz_b + oz_imu_b*rx_b) + R11*(R11*vx_n + R21*vy_n + R31*vz_n + b_arsz_b*ry_b - b_arsy_b*rz_b + oy_imu_b*rz_b - oz_imu_b*ry_b))/((R12*vx_n + R22*vy_n + R32*vz_n - b_arsz_b*rx_b + b_arsx_b*rz_b - ox_imu_b*rz_b + oz_imu_b*rx_b)^2 + (R11*vx_n + R21*vy_n + R31*vz_n + b_arsz_b*ry_b - b_arsy_b*rz_b + oy_imu_b*rz_b - oz_imu_b*ry_b)^2)^(1/2), (R22*(R12*vx_n + R22*vy_n + R32*vz_n - b_arsz_b*rx_b + b_arsx_b*rz_b - ox_imu_b*rz_b + oz_imu_b*rx_b) + R21*(R11*vx_n + R21*vy_n + R31*vz_n + b_arsz_b*ry_b - b_arsy_b*rz_b + oy_imu_b*rz_b - oz_imu_b*ry_b))/((R12*vx_n + R22*vy_n + R32*vz_n - b_arsz_b*rx_b + b_arsx_b*rz_b - ox_imu_b*rz_b + oz_imu_b*rx_b)^2 + (R11*vx_n + R21*vy_n + R31*vz_n + b_arsz_b*ry_b - b_arsy_b*rz_b + oy_imu_b*rz_b - oz_imu_b*ry_b)^2)^(1/2), (R32*(R12*vx_n + R22*vy_n + R32*vz_n - b_arsz_b*rx_b + b_arsx_b*rz_b - ox_imu_b*rz_b + oz_imu_b*rx_b) + R31*(R11*vx_n + R21*vy_n + R31*vz_n + b_arsz_b*ry_b - b_arsy_b*rz_b + oy_imu_b*rz_b - oz_imu_b*ry_b))/((R12*vx_n + R22*vy_n + R32*vz_n - b_arsz_b*rx_b + b_arsx_b*rz_b - ox_imu_b*rz_b + oz_imu_b*rx_b)^2 + (R11*vx_n + R21*vy_n + R31*vz_n + b_arsz_b*ry_b - b_arsy_b*rz_b + oy_imu_b*rz_b - oz_imu_b*ry_b)^2)^(1/2)]
 
 
H_acc =
 
[ 0, 0, 0]
 
 
H_att =
 
[ ((R13*vx_n + R23*vy_n + R33*vz_n)*(R12*vx_n + R22*vy_n + R32*vz_n - b_arsz_b*rx_b + b_arsx_b*rz_b - ox_imu_b*rz_b + oz_imu_b*rx_b))/((R12*vx_n + R22*vy_n + R32*vz_n - b_arsz_b*rx_b + b_arsx_b*rz_b - ox_imu_b*rz_b + oz_imu_b*rx_b)^2 + (R11*vx_n + R21*vy_n + R31*vz_n + b_arsz_b*ry_b - b_arsy_b*rz_b + oy_imu_b*rz_b - oz_imu_b*ry_b)^2)^(1/2), -((R13*vx_n + R23*vy_n + R33*vz_n)*(R11*vx_n + R21*vy_n + R31*vz_n + b_arsz_b*ry_b - b_arsy_b*rz_b + oy_imu_b*rz_b - oz_imu_b*ry_b))/((R12*vx_n + R22*vy_n + R32*vz_n - b_arsz_b*rx_b + b_arsx_b*rz_b - ox_imu_b*rz_b + oz_imu_b*rx_b)^2 + (R11*vx_n + R21*vy_n + R31*vz_n + b_arsz_b*ry_b - b_arsy_b*rz_b + oy_imu_b*rz_b - oz_imu_b*ry_b)^2)^(1/2), -(2*(R11*vx_n + R21*vy_n + R31*vz_n)*(R12*vx_n + R22*vy_n + R32*vz_n - b_arsz_b*rx_b + b_arsx_b*rz_b - ox_imu_b*rz_b + oz_imu_b*rx_b) - 2*(R12*vx_n + R22*vy_n + R32*vz_n)*(R11*vx_n + R21*vy_n + R31*vz_n + b_arsz_b*ry_b - b_arsy_b*rz_b + oy_imu_b*rz_b - oz_imu_b*ry_b))/(2*((R12*vx_n + R22*vy_n + R32*vz_n - b_arsz_b*rx_b + b_arsx_b*rz_b - ox_imu_b*rz_b + oz_imu_b*rx_b)^2 + (R11*vx_n + R21*vy_n + R31*vz_n + b_arsz_b*ry_b - b_arsy_b*rz_b + oy_imu_b*rz_b - oz_imu_b*ry_b)^2)^(1/2))]
 
 
H_ars =
 
[ (rz_b*(R12*vx_n + R22*vy_n + R32*vz_n - b_arsz_b*rx_b + b_arsx_b*rz_b - ox_imu_b*rz_b + oz_imu_b*rx_b))/((R12*vx_n + R22*vy_n + R32*vz_n - b_arsz_b*rx_b + b_arsx_b*rz_b - ox_imu_b*rz_b + oz_imu_b*rx_b)^2 + (R11*vx_n + R21*vy_n + R31*vz_n + b_arsz_b*ry_b - b_arsy_b*rz_b + oy_imu_b*rz_b - oz_imu_b*ry_b)^2)^(1/2), -(rz_b*(R11*vx_n + R21*vy_n + R31*vz_n + b_arsz_b*ry_b - b_arsy_b*rz_b + oy_imu_b*rz_b - oz_imu_b*ry_b))/((R12*vx_n + R22*vy_n + R32*vz_n - b_arsz_b*rx_b + b_arsx_b*rz_b - ox_imu_b*rz_b + oz_imu_b*rx_b)^2 + (R11*vx_n + R21*vy_n + R31*vz_n + b_arsz_b*ry_b - b_arsy_b*rz_b + oy_imu_b*rz_b - oz_imu_b*ry_b)^2)^(1/2), -(rx_b*(R12*vx_n + R22*vy_n + R32*vz_n - b_arsz_b*rx_b + b_arsx_b*rz_b - ox_imu_b*rz_b + oz_imu_b*rx_b) - ry_b*(R11*vx_n + R21*vy_n + R31*vz_n + b_arsz_b*ry_b - b_arsy_b*rz_b + oy_imu_b*rz_b - oz_imu_b*ry_b))/((R12*vx_n + R22*vy_n + R32*vz_n - b_arsz_b*rx_b + b_arsx_b*rz_b - ox_imu_b*rz_b + oz_imu_b*rx_b)^2 + (R11*vx_n + R21*vy_n + R31*vz_n + b_arsz_b*ry_b - b_arsy_b*rz_b + oy_imu_b*rz_b - oz_imu_b*ry_b)^2)^(1/2)]
 
 
y_gss =
 
(d_vx_n + vx_n)*(R11 + R12*d_theta_z - R13*d_theta_y) + (d_vy_n + vy_n)*(R21 + R22*d_theta_z - R23*d_theta_y) + (d_vz_n + vz_n)*(R31 + R32*d_theta_z - R33*d_theta_y) - rz_b*(b_arsy_b + d_b_arsy_b - oy_imu_b) + ry_b*(b_arsz_b + d_b_arsz_b - oz_imu_b)
 
</pre><p class="footer"><br><a href="https://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2018b</a><br></p></div><!--
##### SOURCE BEGIN #####
clc
clear all

%%

z31 = zeros(3,1);
z_151 = zeros(15,1);

%% pos
syms px_n py_n pz_n real
p_hat = [px_n; py_n; pz_n];
syms d_px_n d_py_n d_pz_n real
d_p = [d_px_n; d_py_n; d_pz_n];
p = p_hat + d_p

%% vel 

syms vx_n vy_n vz_n real
v_hat = [vx_n; vy_n; vz_n];
syms d_vx_n d_vy_n d_vz_n real
d_v = [d_vx_n; d_vy_n; d_vz_n];

v = v_hat + d_v

%% acc
syms b_accx_b b_accy_b b_accz_b real
b_acc_b_hat = [b_accx_b; b_accy_b; b_accz_b];
syms d_b_accx_b d_b_accy_b d_b_accz_b real
d_b_acc = [d_b_accx_b; d_b_accy_b; d_b_accz_b];

b_acc_b = b_acc_b_hat + d_b_acc


%% att
syms d_theta_x d_theta_y d_theta_z real
d_theta = [d_theta_x; d_theta_y; d_theta_z];
d_R = eye(3) + Smtrx(d_theta)
%syms q_w q_x q_y q_z real
%q = [q_w; q_x; q_y; q_z];
%R_hat = quat2rotMat_fast(q )
syms R11 R12 R13 R21 R22 R23 R31 R32 R33 real
R_hat = [...
    R11 R12 R13; 
    R21 R22 R23;
    R31 R32 R33 ]
R = R_hat*d_R;

%% ars
syms b_arsx_b b_arsy_b b_arsz_b real
b_ars_b_hat = [b_arsx_b; b_arsy_b; b_arsz_b];
syms d_b_arsx_b d_b_arsy_b d_b_arsz_b real
d_b_ars = [d_b_arsx_b; d_b_arsy_b; d_b_arsz_b];

b_ars_b = b_ars_b_hat + d_b_ars

%% error state def
d_x = [d_p; d_v; d_b_acc; d_theta; d_b_ars];

%% imu
% syms ox_b oy_b oz_b real
% omega_nb = [ox_b oy_b oz_b];
% syms wx_ars_b wy_ars_b wz_ars_b real
% w_ars_b = [wx_ars_b; wy_ars_b; wz_ars_b]
syms ox_imu_b oy_imu_b oz_imu_b real
omega_imu_b = [ox_imu_b; oy_imu_b; oz_imu_b]

%% lever arm
syms rx_b ry_b rz_b real
r_b = [rx_b; ry_b; rz_b ]

%% simple measurement
H_alloc = [1 0 0];
y_gss = H_alloc*( R'*v + Smtrx( omega_imu_b - b_ars_b)*r_b );
y_hat = subs(y_gss, d_x, z_151 )
H = jacobian( y_gss, d_x );
H = simplify( subs( H, d_x, zeros(15,1) ));
H_pos = H(:,1:3)
H_vel = H(:,4:6)
H_acc = H(:,7:9)
H_att = H(:,10:12)
H_ars = H(:,13:15)

% matriseregne sjekk, svar skal bli null
delta_H_pos = H(:,1:3) - H_alloc*z31
delta_H_vel = H(:,4:6) - H_alloc*R_hat'
delta_H_acc = H(:,7:9) - H_alloc*z31 
delta_H_att = H(:,10:12) - H_alloc*Smtrx( R_hat'*v_hat )
delta_H_ars = H(:,13:15) - [1 0 0]*Smtrx(r_b)

%% measurement
H_alloc = [1 0 0; 0 1 0; 0 0 0];
velocity_gss = H_alloc*( R'*v + Smtrx( omega_imu_b - b_ars_b)*r_b );
y_gss = norm( velocity_gss );
y_hat = simplify( subs(y_gss, d_x, z_151 ) );
H = jacobian( y_gss, d_x );
H = simplify( subs( H, d_x, zeros(15,1) ) )

%
H_pos = H(:,1:3)
H_vel = H(:,4:6)
H_acc = H(:,7:9)
H_att = H(:,10:12)
H_ars = H(:,13:15)

% se på forskjellen til 
H_alloc = [1 0 0];
y_gss = H_alloc*( R'*v + Smtrx( omega_imu_b - b_ars_b)*r_b ) 
% og 
H_alloc = [1 0 0; 0 1 0; 0 0 0];
velocity_gss = H_alloc*( R'*v + Smtrx( omega_imu_b - b_ars_b)*r_b );
y_gss = norm( velocity_gss );
% i simulatoren
##### SOURCE END #####
--></body></html>